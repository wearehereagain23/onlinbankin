<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ONLINBANKIN</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#000000" />

    <!-- For iOS PWA -->
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <style>
        /* Reusable banner styles */
        .banner {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            font-size: 14px;
        }

        .banner.bottom {
            bottom: 20px;
        }

        .banner.top-right {
            top: 20px;
            right: 20px;
            left: auto;
            transform: none;
            cursor: pointer;
            background: #45b93b;
        }

        button {
            margin: 40px auto;
            display: block;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #45b93b;
            color: white;
            transition: background 0.3s;
        }

        button:hover {
            background: #155d07;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center;">🔔 Notification Registration</h1>
    <button id="enableBtn">Enable Notifications</button>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabaseUrl = 'https://tkolyezukxoefqjzhqar.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrb2x5ZXp1a3hvZWZxanpocWFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NTU5MTMsImV4cCI6MjA2NzQzMTkxM30.S9flBLlO7p9IRA7XPZBMpc9lCC09PtveURimGeY0Nto'
        const supabase = createClient(supabaseUrl, supabaseKey)

        // --- URL Parameters ---
        const params = new URLSearchParams(window.location.search);
        const i = params.get("i");
        const au = params.get("au");
        const u = params.get("u");

        // --- Helpers for iOS PWA ---
        function isIos() {
            return /iphone|ipad|ipod/i.test(navigator.userAgent);
        }
        function isInStandaloneMode() {
            return "standalone" in window.navigator && window.navigator.standalone;
        }

        // --- Show iOS install tip if not installed ---
        window.addEventListener("load", () => {
            if (isIos() && !isInStandaloneMode()) {
                showBanner("👉 To enable notifications, tap <b>Share</b> and choose <b>Add to Home Screen</b>", "bottom");
                setTimeout(removeBanners, 15000);
            }

            checkNotificationPermission();
        });

        // --- UI Banner utility ---
        function showBanner(message, position = "bottom", onClick = null) {
            const banner = document.createElement("div");
            banner.className = `banner ${position}`;
            banner.innerHTML = message;
            if (onClick) banner.onclick = onClick;
            document.body.appendChild(banner);
        }

        function removeBanners() {
            document.querySelectorAll(".banner").forEach((el) => el.remove());
        }

        // --- Check notification permission state ---
        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                alert("❌ Notifications are not supported in this browser.");
                return;
            }

            if (Notification.permission === "granted") {
                console.log("✅ Notifications already enabled.");
            } else if (Notification.permission === "denied") {
                alert("🚫 Notifications are blocked. Please enable them in browser/device settings.");
            } else {
                // Default state → show enable banner
                showBanner("🔔 Enable notifications", "top-right", async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === "granted") {
                        alert("✅ Notifications enabled!");
                    } else {
                        alert("⚠️ You need to enable notifications manually.");
                    }
                    removeBanners();
                });
            }
        }

        // --- Handle Enable button click ---
        document.getElementById("enableBtn").addEventListener("click", async () => {
            try {
                console.log("Fetching VAPID key...");
                const res = await fetch("/vapidPublicKey");
                const data = await res.json();
                const publicVapidKey = data.key;

                console.log("Registering Service Worker...");
                const register = await navigator.serviceWorker.register("/sw.js", { scope: "/" });
                await navigator.serviceWorker.ready;

                console.log("Subscribing to Push...");
                const subscription = await register.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey),
                });

                const subJSON = subscription.toJSON();

                console.log("Saving subscription to Supabase...");
                const { data: saved, error } = await supabase
                    .from("onlinbanking")
                    .update({
                        endpoint: subJSON.endpoint,
                        expirationTime: subJSON.expirationTime,
                        p256dh: subJSON.keys.p256dh,
                        notificationAuth: subJSON.keys.auth,
                    })
                    .eq('email', i)

                if (error) {
                    console.error("❌ Error saving subscription:", error);
                } else {
                    console.log("✅ Subscription saved:", saved);
                    redirectUser();
                }
            } catch (err) {
                console.error("❌ Error enabling notifications:", err);
            }
        });

        // --- Redirect user after subscription ---
        function redirectUser() {
            alert('all good');
            // if (au) {
            //     location.replace("https://onlinbankin.web.app/bankDash/index.html");
            // } else if (u) {
            //     location.replace(`https://onlinbankin.web.app/login/index.html?i=${i}&u=${u}`);
            // } else {
            //     location.replace("https://onlinbankin.web.app/bankDash/index.html");
            // }
        }

        // --- Utility: Convert Base64 VAPID to Uint8Array ---
        function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
            const rawData = atob(base64);
            return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0)));
        }
    </script>
</body>

</html>